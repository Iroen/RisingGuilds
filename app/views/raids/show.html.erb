<div id="content_menu">
	<ul>
		<% permitted_to? :edit, @raid do %>
		<li><%= params[:guild_id].nil? ? link_to("Edit",edit_raid_path(@raid)) : link_to("Edit",edit_guild_raid_path(Guild.find(params[:guild_id]),@raid))%></li>
		<% end %>
		<% permitted_to? :destroy, @raid do %>
		<li><%= link_to('Destroy', @raid, :confirm => 'Are you really sure? Destroyed raids can\'t be restored!', :method => :delete) %></li>
		<% end %>
	</ul>
</div>

<div style="position:relative; width:100%">
	
	<%- @raid.icon = "nil.png" if @raid.icon == "" -%>
	<div id="raidicon"><%= image_tag("/images/icons/raid/#{@raid.icon}", :size => "65x65") %></div>
</div>

<h1><%= @raid.title %></h1>


<% if @raid.start > Time.now %>
<h4>Raid starts in <%= time_ago_in_words(@raid.start)%></h4>
<% end %>

<% unless @raid.description.empty? %>
<div id="description">
	<%= @raid.description %>
</div>
<% end %>

<table width="100%" border="0" cellspacing="1" cellpadding="0" class="contentRaid">
    <tr>
	<th width="25%"></th>
	<th width="25%"></th>
	<th width="25%"></th>
	<th width="25%"></th>	
    </tr>

    <tr>
    <td><div align="left" class="raidcontent"><b>participating Guilds</b>:</div></td>
    <td><div align="left" class="raidcontent"><% @raid.guilds.each do |g| %>
		<ul class="guildslist">
			<li><%= link_to(g.name, guild_path(g))  %> <%= link_to(image_tag("icons/kick.png", :size => "10x10"), :controller => 'raids', :action => 'uninvite_guild', :id => @raid.id, :uninvited_guild => g.id) if permitted_to?(:uninvite_guild, @raid) && g != @raid.guild %></li>
		</ul>
	<% end %></div></td>
	<td colspan="2">
			<% if permitted_to? :edit %>
			<%= form_for(@raid) do |f| %>
				<%= f.text_field :invited_guild %>
				<%= f.submit 'Invite' %>
			<% end %>
			<% end %>
	</div></td>
    </tr>

    <tr>
    <td><div align="left" class="raidcontent"><b>Raidleiter</b>:</div></td>
    <td><div align="left" class="raidcontent"><span class="leader"><%=h User.find(@raid.leader).login %></span></div></td>
    <td><div align="left" class="raidcontent"><b>Confirmed Members</b>:</div></td>
    <td><div align="left" class="raidcontent"><% att_s = @raid.attendances.find_all_by_status(3).count %><%= "#{att_s}/#{@raid.max_attendees} (#{Integer(att_s.to_f / @raid.max_attendees.to_f * 100)}%)"%></div></td>
    </tr>

    <tr>
    <td><div align="left" class="raidcontent"><b>Invite Start</b>:</div></td>
    <td><div align="left" class="raidcontent"><%=h @raid.date %> @ <%=h @raid.invite_start.strftime("%H:%M") %></div></td>
    <td><div align="left" class="raidcontent"><b>Available Members </b>:</div></td>
    <td><div align="left" class="raidcontent"><% att_s = @raid.attendances.find_all_by_status(2).count %><%= "#{att_s}/#{@raid.max_attendees} (#{Integer(att_s.to_f / @raid.max_attendees.to_f * 100)}%)"%></div></td>
    </tr>

    <tr>
    <td><div align="left" class="raidcontent"><b>Start</b>:</div></td>
    <td><div align="left" class="raidcontent"><%=h @raid.date %> @ <%=h @raid.start.strftime("%H:%M") %></div></td>
    <td><div align="left" class="raidcontent"><b>Not Available Members </b>:</div></td>
    <td><div align="left" class="raidcontent"><% att_s = @raid.attendances.find_all_by_status(1).count %><%= "#{att_s}/#{@raid.max_attendees} (#{Integer(att_s.to_f / @raid.max_attendees.to_f * 100)}%)"%></div></td>
    </tr>

    <tr>
    <td><div align="left" class="raidcontent"><b>End</b>:</div></td>
    <td><div align="left" class="raidcontent"><%=h @raid.date %> @ <%= @raid.end.strftime("%H:%M") %></div></td>
    <td><div align="left" class="raidcontent"></div></td>
    <td><div align="left" class="raidcontent"></div></td>
    </tr>

    <tr>
    <td><div align="left" class="raidcontent"><b>Level Range</b>:</div></td>
    <td><div align="left" class="raidcontent"><%= @raid.levelrange %></div></td>
	<td><div align="left" class="raidcontent"><b>Max attendees</b>:</div></td>
    <td><div align="left" class="raidcontent"><%=h @raid.max_attendees %></div></td>
    </tr>
</table>

<h2>Attendees</h2>

<table width="100%" cellpadding="0" cellspacing="0" border="0" >
	<thead>
	  <tr>
		<th style="text-align: left;">Name</th>
		<th class="narrow">Level</th>
		<th class="narrow">Race</th>
		<th class="narrow">Class</th>
		<th class="narrow">Role</th>
		<th style="text-align: left;">Message</th>
		<th></th>
	  </tr>
	</thead>
	<% configatron.raidplanner.status_manager.size.downto(1) do |i| %>
	<tbody>
	  <tr valign="top" class="header">
	  <th colspan="6"><%=h configatron.raidplanner.status_manager.key(i) %></th>
		<th></th>
	  </tr>
	  <% @raid.attendances.find_all_by_status(i).each do |attendance|%>
	  <tr>
	    <td class="left"><%= link_to attendance.character.name, character_path(attendance.character) %></td>
	    <td><%=h attendance.character.level %></td>
			<td><%= image_tag raceicon_path(attendance.character),:size => "18x18" %></td>
			<td><%= image_tag classicon_path(attendance.character),:size => "18x18" %></td>
	    <td><%=h attendance.role %></td>
	    <td  class="left"><%=h attendance.message %></td>
	    <td><%= link_to((attendance.status==3 ? "reject" : "approve"), {:controller => :attendances, :id => attendance.id , :action => :approve}) if permitted_to?(:approve,attendance) && (i==2 || i==3)%></td>
	  </tr>
	  <% end %>
	</tbody>
	<% end %>
</table>

<% unless current_user.characters.empty? %>
<h2>Create / Change Attendance</h2>

<% if @attendance.new_record? %>
<%= render :partial => "new_attend_form", :object => @attendance %>
<% else %>
<%= render :partial => "update_attend_form", :object => @attendance%>
<% end %>
<% else%>
<h2>Please connect a character to your account</h2>
<% end %>
<script>
$(function() {
	$( "#raid_invited_guild" ).autocomplete({
		source: "/guilds.json",
		minLength: 2,
	});
});
</script>
